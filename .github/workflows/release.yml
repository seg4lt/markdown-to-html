name: Release

on:
  push:
    tags:
      - 'v*'

env:
  ZIG_VERSION: 0.15.2
  ZIG_MINISIGN_PUBKEY: RWSGOq2NVecA2UPNdBUZykf1CCb147pkmdtYxgb3Ti+JO/wCYvhbAb/U

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Zig
        id: cache-zig
        uses: actions/cache@v4
        with:
          path: ~/zig
          key: zig-linux-x86_64-${{ env.ZIG_VERSION }}

      - name: Download Zig
        if: steps.cache-zig.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y minisign
          
          wget -q https://ziglang.org/download/${{ env.ZIG_VERSION }}/zig-x86_64-linux-${{ env.ZIG_VERSION }}.tar.xz
          wget -q https://ziglang.org/download/${{ env.ZIG_VERSION }}/zig-x86_64-linux-${{ env.ZIG_VERSION }}.tar.xz.minisig
          
          minisign -Vm zig-x86_64-linux-${{ env.ZIG_VERSION }}.tar.xz -P ${{ env.ZIG_MINISIGN_PUBKEY }}
          
          mkdir -p ~/zig
          tar -xf zig-x86_64-linux-${{ env.ZIG_VERSION }}.tar.xz -C ~/zig --strip-components=1
          rm zig-x86_64-linux-${{ env.ZIG_VERSION }}.tar.xz zig-x86_64-linux-${{ env.ZIG_VERSION }}.tar.xz.minisig
          
      - name: Add Zig to PATH
        run: echo "$HOME/zig" >> $GITHUB_PATH

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: .zig-cache
          key: zig-build-${{ runner.os }}-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-build-${{ runner.os }}-

      - name: Build for macOS ARM64
        run: |
          zig build -Dtarget=aarch64-macos -Doptimize=ReleaseSafe
          mv zig-out/bin/m2h m2h-${{ steps.get_version.outputs.VERSION }}-macos-arm64

      - name: Build for Linux x64
        run: |
          zig build -Dtarget=x86_64-linux -Doptimize=ReleaseSafe
          mv zig-out/bin/m2h m2h-${{ steps.get_version.outputs.VERSION }}-linux-x64

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            m2h-${{ steps.get_version.outputs.VERSION }}-macos-arm64
            m2h-${{ steps.get_version.outputs.VERSION }}-linux-x64
          body: |
            ## Downloads
            
            - **macOS ARM64**: `m2h-${{ steps.get_version.outputs.VERSION }}-macos-arm64`
            - **Linux x64**: `m2h-${{ steps.get_version.outputs.VERSION }}-linux-x64`
            
            Make the binary executable after downloading:
            ```bash
            chmod +x m2h-${{ steps.get_version.outputs.VERSION }}-*
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}